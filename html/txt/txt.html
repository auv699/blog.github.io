<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªé€‚åº”è®°äº‹æœ¬</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; }
        button { padding: 10px 15px; margin-right: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ“ è‡ªé€‚åº”è®°äº‹æœ¬</h2>
    <textarea id="noteContent" placeholder="è¾“å…¥ä½ çš„å†…å®¹..."></textarea>
    <input type="file" id="imageUpload" accept="image/*">
    <button onclick="saveNote()">ğŸ’¾ ä¿å­˜</button>
    <button onclick="loadNote()">ğŸ“‚ åŠ è½½</button>
    
    <p id="status"></p>
    <p><strong>åˆ†äº«é“¾æ¥ï¼š</strong> <a id="shareLink" target="_blank"></a></p>

    <script>
        const GITHUB_TOKEN = "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";  // â— æ›¿æ¢ä¸ºä½ çš„ GitHub Token
        let gistId = localStorage.getItem("gistId"); // è®°ä½ä¸Šæ¬¡ä¿å­˜çš„ Gist

        async function saveNote() {
            let content = document.getElementById("noteContent").value;
            let imageFile = document.getElementById("imageUpload").files[0];
            let imageData = "";

            if (imageFile) {
                let reader = new FileReader();
                reader.onloadend = function () {
                    imageData = reader.result.split(",")[1]; // è·å– Base64 æ•°æ®
                    uploadGist(content, imageData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                uploadGist(content, imageData);
            }
        }

        async function uploadGist(text, image) {
            let files = { "note.txt": { "content": text } };
            if (image) {
                files["image.txt"] = { "content": image }; // å­˜å‚¨ Base64 å›¾ç‰‡
            }

            let method = gistId ? "PATCH" : "POST";
            let url = gistId ? `https://api.github.com/gists/${gistId}` : "https://api.github.com/gists";

            let response = await fetch(url, {
                method: method,
                headers: {
                    "Authorization": `Bearer ${GITHUB_TOKEN}`,
                    "Accept": "application/vnd.github.v3+json",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ "description": "è®°äº‹æœ¬ Gist", "public": true, "files": files })
            });

            let data = await response.json();
            if (data.id) {
                gistId = data.id;
                localStorage.setItem("gistId", gistId);
                document.getElementById("shareLink").href = `?id=${gistId}`;
                document.getElementById("shareLink").textContent = `æŸ¥çœ‹ Gist`;
                document.getElementById("status").textContent = "âœ… ä¿å­˜æˆåŠŸï¼";
            } else {
                document.getElementById("status").textContent = "âŒ ä¿å­˜å¤±è´¥ï¼";
            }
        }

        async function loadNote() {
            let params = new URLSearchParams(window.location.search);
            let id = params.get("id") || gistId;

            if (!id) {
                document.getElementById("status").textContent = "âš  æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„ç¬”è®°ï¼";
                return;
            }

            let response = await fetch(`https://api.github.com/gists/${id}`);
            let data = await response.json();

            if (data.files["note.txt"]) {
                document.getElementById("noteContent").value = data.files["note.txt"].content;
            }
            if (data.files["image.txt"]) {
                let img = document.createElement("img");
                img.src = "data:image/png;base64," + data.files["image.txt"].content;
                img.style.maxWidth = "100%";
                document.body.appendChild(img);
            }

            document.getElementById("status").textContent = "âœ… åŠ è½½æˆåŠŸï¼";
        }

        window.onload = function () {
            if (window.location.search.includes("id=")) {
                loadNote();
            }
        };
    </script>

</body>
</html>
